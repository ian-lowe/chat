{% extends "template.html" %}
{% block title %}Index{% endblock %}
{% block js %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"></script>
    <script>
        var socket = io();
        var nickname = "{{ nickname }}";
        var current_room = "";

        // set up chat room on initial visit
        socket.on("connect", function () {
            current_room = "#general";
            socket.emit("join", current_room);

            // functionality for channel creation
            document.querySelectorAll("button")[0].addEventListener("click", function() {
                let channel_name = document.getElementById("new-channel").value;
                if(channel_name == "") {
                    return;
                }
                channel_name = "#" + channel_name;
                channel_name = channel_name.toLowerCase();
                document.getElementById("new-channel").value = "";
                socket.emit("create channel", channel_name);
            });

            document.querySelector(".div2 input").addEventListener("keyup", function() {
                if(event.key === "Enter") {
                    let channel_name = document.getElementById("new-channel").value;
                    if (channel_name == "") {
                        return;
                    }
                    channel_name = "#" + channel_name;
                    channel_name = channel_name.toLowerCase();
                    document.getElementById("new-channel").value = "";
                    socket.emit("create channel", channel_name);
                }
            });

            // functionality for sending a message
            document.querySelectorAll("button")[1].addEventListener("click", function () {
                let message_input = document.querySelector(".div4 input");
                let message = message_input.value;
                if(message == "") {
                    return;
                }
                message_input.value = "";
                message_input.focus();
                socket.emit("submit msg", message, nickname, current_room);
            });

            document.querySelector(".div4 input").addEventListener("keyup", function() {
                if(event.key === "Enter") {
                    let message_input = document.querySelector(".div4 input");
                    let message = message_input.value;
                    if (message == "") {
                        return;
                    }
                    message_input.value = "";
                    message_input.focus();
                    socket.emit("submit msg", message, nickname, current_room);
                }
            });

            // set up default channel to accept click event
            document.querySelector("#general").addEventListener("click", function() {
                // set message placeholder to reflect current channel
                document.querySelector(".div4 input").setAttribute("placeholder", "Message " + this.innerText);
                // style channels to reflect selection
                let channels = document.querySelectorAll(".div1 div");
                for(channel of channels) {
                    channel.classList.remove("selected-channel");
                }
                this.classList.add("selected-channel");
                // keep message box in focus regardless of channel switch
                document.querySelector(".div4 input").focus();
                // join room
                socket.emit("leave", current_room);
                current_room = "#general";
                socket.emit("join", current_room);
            });

            // alert of new user
            socket.emit("user connected", nickname);
        });

        // set up any newly created channel to accept click event
        socket.on("broadcast channel", function(channel_name) {
            // create div for channel
            const new_div = document.createElement("div");
            new_div.innerText = channel_name;
            document.querySelector(".div1").append(new_div);
            // set up newly created channel to accept click event
            new_div.addEventListener("click", function() {
                // set message placeholder to reflect current channel
                document.querySelector(".div4 input").setAttribute("placeholder", "Message " + this.innerText);
                // style channels to reflect selection
                let channels = document.querySelectorAll(".div1 div");
                for (channel of channels) {
                    channel.classList.remove("selected-channel");
                }
                this.classList.add("selected-channel");
                // keep message box in focus regardless of channel switch
                document.querySelector(".div4 input").focus();
                // join room
                socket.emit("leave", current_room);
                current_room = channel_name;
                socket.emit("join", channel_name);
                socket.emit("display messages", channel_name);
            });
        });

        // socket.on("render room", function(room_messages) {
        //     // let message_list = document.querySelector("#messages");
        //     // while (message_list.hasChildNodes()) {
        //     //     message_list.removeChild(message_list.lastChild);
        //     // }
        //     // for(msg of messages) {

        //     // }
        //     console.log(room_messages["message"]);
        // });

        socket.on("broadcast msg", function(message, nickname, timestamp) {
            const li = document.createElement("li");
            li.innerText = `${timestamp} ${nickname}: ${message}`;
            document.querySelector("#messages").append(li);
        });

        // socket.on("on connection", function(nickname) {
        //     document.querySelectorAll("li")[2].innerText = nickname + " has connected.";
        // });


    </script>
{% endblock %}
{% block body %}
    <div class="parent">
        <div class="div1">
            <h5>Channels</h5>
            <div class="selected-channel" id="general">#general</div>
        </div>
        <div class="div2">
            <input type="text" placeholder="Create Channel.." id="new-channel">
            <button>+</button>
        </div>
        <div class="div3">
            <ul id="messages">
                {% for message in messages %}
                    <li>{{ message["timestamp"] }} {{ message["nickname"] }}: {{ message["message"] }}</li>
                {% endfor %}
            </ul>
        </div>
        <div class="div4">
            <button><img src="/static/send.svg" alt="send"></button>
            <input type="text" placeholder="Message #general" autofocus>
        </div>
    </div>
{% endblock %}